<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <title>Sleeve</title>

    <!-- Babylon.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
    <script src="https://assets.babylonjs.com/generated/Assets.js"></script>
    <script src="https://preview.babylonjs.com/ammo.js"></script>
    <script src="https://preview.babylonjs.com/cannon.js"></script>
    <script src="https://preview.babylonjs.com/Oimo.js"></script>
    <script src="https://preview.babylonjs.com/earcut.min.js"></script>
    <script src="https://preview.babylonjs.com/babylon.js"></script>
    <script src="https://preview.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
    <script src="https://preview.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js"></script>
    <script src="https://preview.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
    <script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.js"></script>
    <script src="https://preview.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
    <script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>
    <script src="https://preview.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>

    <style>
        html,
        body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>
</head>

<body>
    <form action="/action_page.php" style="position: absolute; bottom: 0px; width: 250px; height: 40px; left: 15px;">
        <!-- <label for="CustomTattoo">Add custom tattoo</label> -->
        <input name="CustomTattoo" id="loadFile" type="file" accept="image/png, image/jpeg">
    </form>



    <canvas id="renderCanvas"></canvas>
    <script>

        var canvas = document.getElementById("renderCanvas");

        var startRenderLoop = function (engine, canvas) {
            engine.runRenderLoop(function () {
                if (sceneToRender && sceneToRender.activeCamera) {
                    sceneToRender.render();
                }
            });
        }

        var engine = null;
        var scene = null;
        var sceneToRender = null;
        var createDefaultEngine = function () { return new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true, disableWebGL2Support: false }); };

        var fileInput = document.getElementById("loadFile");

        var createScene = function () {
            // SCENE
            var scene = new BABYLON.Scene(engine);
            var clearColor = 0.06;
            var ambientColor = 0.2;
            scene.clearColor = new BABYLON.Color3(clearColor, clearColor, clearColor);
            scene.ambientColor = new BABYLON.Color3(ambientColor, ambientColor, ambientColor);
            var canvas = engine.getRenderingCanvas();
            // END SCENE
            // VARIABLES
            var scrollWidth = 0.2;
            var selected = false;
            var moved = false;
            var scaling = false;
            var rotating = false;
            var currentDecal = 0;
            var currentDecalPickInfo;
            var originalScale = 2;
            var tattooScale = originalScale;
            var tattooAngle = 0;
            const minScale = 0.9;
            var isLeft = true;
            var isMobile = true;
            var isVertical = false;
            var currentTargetBody;
            var bodyMeshes = [null, null, null, null];
            var bodyButtons = [null, null, null, null];
            var startingScale = 1;
            var inputFocus = false;
            var gd;
            var scrolling = false;
            var sv;
            var scrollPos = 0;
            var startHeight = 1;
            if (navigator && navigator.userAgentData)
                isMobile = navigator.userAgentData.mobile; //resolves true/false
            isVertical = window.innerHeight > window.innerWidth;
            if (isVertical)
                scrollWidth = 0.2
            else
                scrollWidth = 0.05
            // END VARIABLES        
            // CAMERA
            // This creates and positions an ArcRotateCamera
            var camera = new BABYLON.ArcRotateCamera("camera", Math.PI / 3, Math.PI / 3, 30,
                BABYLON.Vector3.Zero(), scene);
            // This targets the camera to scene origin
            camera.setTarget(BABYLON.Vector3.Zero());
            camera.wheelPrecision = 12; //Mouse wheel speed
            //console.log(camera.panningSensibility); //Mouse wheel speed
            camera.panningSensibility = 1500;
            camera.pinchToPanMaxDistanceSearch = 50
            camera.pinchPrecision = 1000
            // This attaches the camera to the canvas
            camera.attachControl(canvas, true);
            // END CAMERA
            // LIGHTING
            var light = new BABYLON.HemisphericLight("Hemi", new BABYLON.Vector3(0, 1, 0), scene);
            light.intensity = 1.0;
            // var light = new BABYLON.HemisphericLight("Hemi", new BABYLON.Vector3(0, -1, 0), scene);
            // light.intensity = 0.2;
            // END LIGHTING
            // GUI SECTION 
            var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");
            if (isVertical)
                advancedTexture.idealHeight = 1080;
            else
                advancedTexture.idealWidth = 1920;
            advancedTexture.renderAtIdealSize = true
            var compareHeight = advancedTexture.getSize().height;
            var compareWidth = advancedTexture.getSize().width;
            //console.log(compareWidth)
            // var baseHeight = advancedTexture.getInternalTexture();
            //     console.log(advancedTexture)
            // console.log(advancedTexture.getInternalTexture().height)
            // console.log(advancedTexture.getSize())
            // console.log(advancedTexture.getBaseSize())
            // console.log(window.innerHeight)
            var numSkin = 0;
            var createSkinColorButton = function (color) {
                var offset = 205;
                col = color.toHexString();
                var button1 = BABYLON.GUI.Button.CreateSimpleButton("but1", "");
                button1.width = "60px"
                button1.color = col;
                button1.background = col;
                height = 60;
                button1.height = height + "px";
                button1.left = "5px";
                button1.top = offset + numSkin * (height + 5) + "px";
                button1.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
                button1.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
                button1.cornerRadius = 15;
                //button1.thickness = 4;
                numSkin++;
                button1.onPointerUpObservable.add(function () {
                    armMaterial.diffuseColor = color;
                    armMaterial.ambientColor = color;
                });
                advancedTexture.addControl(button1);
            }
            var createBodyButtons = function (armMaterial) {
                var topOffset = 205;
                if (isVertical)
                    topOffset = 200 + 200;
                width = 60;
                height = 90;
                left = 70;
                if (isVertical)
                    left = 5;
                // Right arm
                var tempButton = BABYLON.GUI.Button.CreateImageWithCenterTextButton("but1", "",
                    "https://i.imgur.com/W1I0Duq.png");
                tempButton.width = width + "px";

                tempButton.left = left + "px";
                tempButton.height = height + "px";
                tempButton.top = topOffset + "px";
                tempButton.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
                tempButton.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
                tempButton.color = "black";
                tempButton.background = "";
                tempButton.thickness = 2;

                tempButton.onPointerUpObservable.add(function () {
                    //console.log('right arm');
                    selectMesh(0);
                });
                bodyButtons[0] = tempButton;
                advancedTexture.addControl(tempButton);
                // Left arm
                var tempButton = BABYLON.GUI.Button.CreateImageWithCenterTextButton("but1", "",
                    "https://i.imgur.com/AqEzmko.png");
                tempButton.left = left + width + "px";
                tempButton.width = width + "px";
                tempButton.height = height + "px";
                tempButton.top = topOffset + "px";
                tempButton.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
                tempButton.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
                tempButton.color = "black";
                tempButton.background = "";
                tempButton.thickness = 2;

                tempButton.onPointerUpObservable.add(function () {
                    //console.log('left arm')
                    selectMesh(1);

                });
                bodyButtons[1] = tempButton;
                advancedTexture.addControl(tempButton);
                // Right Leg
                var tempButton = BABYLON.GUI.Button.CreateImageWithCenterTextButton("but1", "", "https://i.imgur.com/Y6ANASk.png");
                tempButton.left = left + "px";
                tempButton.width = width + "px";
                tempButton.height = height + "px";
                tempButton.top = topOffset + height + "px";
                tempButton.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
                tempButton.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
                tempButton.color = "black";
                tempButton.background = "";
                tempButton.thickness = 2;
                tempButton.onPointerUpObservable.add(function () {
                    //console.log('right leg')
                    selectMesh(2);
                });
                bodyButtons[2] = tempButton;
                advancedTexture.addControl(tempButton);
                // Left Leg
                var tempButton = BABYLON.GUI.Button.CreateImageWithCenterTextButton("but1", "", "https://i.imgur.com/RX4nZbE.png");
                tempButton.left = left + width + "px";
                tempButton.width = width + "px";
                tempButton.height = height + "px";
                tempButton.top = topOffset + height + "px";
                tempButton.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
                tempButton.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
                tempButton.color = "black";
                tempButton.background = "";
                tempButton.thickness = 2;
                tempButton.onPointerUpObservable.add(function () {
                    //console.log('left leg')
                    selectMesh(3);
                });
                bodyButtons[3] = tempButton;
                advancedTexture.addControl(tempButton);
            }
            var selectMesh = function (index) {
                if (bodyMeshes[0])
                    bodyMeshes[0].setEnabled(false);
                if (bodyMeshes[1])
                    bodyMeshes[1].setEnabled(false);
                if (bodyMeshes[2])
                    bodyMeshes[2].setEnabled(false);
                if (bodyMeshes[3])
                    bodyMeshes[3].setEnabled(false);
                bodyButtons.forEach((button) => { button.background = ""; })

                switch (index) { // ik this is a dumb switch. originally i had some logic in it be rmved it
                    case 0: // right arm
                        currentTargetBody = bodyMeshes[0]
                        break;
                    case 1: // left arm
                        currentTargetBody = bodyMeshes[1]
                        break;
                    case 2: // right leg
                        currentTargetBody = bodyMeshes[2]
                        break;
                    case 3: // left leg
                        currentTargetBody = bodyMeshes[3]
                        break;
                }
                bodyButtons[index].background = "white"
                currentTargetBody.setEnabled(true)
            }
            var loadModels = function (scene, armMaterial) {
                BABYLON.SceneLoader.ImportMesh("",
                    "", "arm_midpoly.obj",
                    scene,
                    function (newMeshes) {
                        //
                        var rightArm = newMeshes[0];
                        rightArm.name = "Right Arm"
                        currentTargetBody = rightArm;
                        rightArm.material = armMaterial;
                        bodyMeshes[0] = rightArm;
                        rightArm.position = new BABYLON.Vector3(0, startHeight, 0);
                        var leftArm = rightArm.clone("Left Arm");
                        bodyMeshes[1] = leftArm;
                        // set up right arm
                        rightArm.scaling = new BABYLON.Vector3(startingScale, startingScale, -startingScale);
                        rightArm.rotation = new BABYLON.Vector3(0, Math.PI / 180 * 200, 0);
                        // set up left arm
                        leftArm.scaling = new BABYLON.Vector3(startingScale, startingScale, startingScale);
                        leftArm.rotation = new BABYLON.Vector3(0, Math.PI / 180 * 20, 0);
                        selectMesh(0);
                    });

                BABYLON.SceneLoader.ImportMesh("",
                    "", "leg_midpoly.obj",
                    scene,
                    function (newMeshes) {
                        scale = 2;
                        //
                        var rightLeg = newMeshes[0];
                        bodyMeshes[2] = rightLeg;
                        rightLeg.name = "Right Leg"
                        rightLeg.setEnabled(false);
                        rightLeg.material = armMaterial;

                        rightLeg.position = new BABYLON.Vector3(0, startHeight, 0);
                        var leftLeg = rightLeg.clone("Left Leg");
                        bodyMeshes[3] = leftLeg;
                        // set up right leg
                        rightLeg.scaling = new BABYLON.Vector3(startingScale, startingScale, -startingScale);
                        rightLeg.rotation = new BABYLON.Vector3(0, Math.PI / 180 * 200, 0);
                        // set up left leg
                        leftLeg.scaling = new BABYLON.Vector3(startingScale, startingScale, startingScale);
                        leftLeg.rotation = new BABYLON.Vector3(0, Math.PI / 180 * 20, 0);
                        // selectMesh(0);
                    });
            }
            // Tattoo
            var currentTop = 30;
            var currentCol = 0;
            var createTattooButton = function (name, index, size) {
                // var buttonSize = 150;
                // if (isVertical)
                //     buttonSize = 90;
                var ratio = size.width / size.height;
                //console.log(name)
                var button1 = BABYLON.GUI.Button.CreateImageWithCenterTextButton(name + "Button", "", name + ".png");
                // console.log(button1)
                //console.log(compareWidth)
                //if (currentTop + calcHeight > window.innerHeight) {
                var buttonSize = compareWidth * scrollWidth - 15;
                var calcHeight = buttonSize / ratio;
                //compareHeight = advancedTexture.getSize().height
                //console.log(currentTop+calcHeight)
                //console.log(compareHeight)
                // if (currentTop + calcHeight + 30 > compareHeight) {
                //     currentTop = 30;
                //     currentCol++;
                // }

                // button1.top = currentTop + "px";
                currentTop += calcHeight;

                // button1.left = (-buttonSize - 10) * currentCol;
                button1.width = buttonSize + "px"
                button1.height = calcHeight + "px";
                button1.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
                button1.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
                button1.color = "black";
                button1.background = "white";
                button1.cornerRadius = 10;

                button1.onPointerUpObservable.add(function (data) {
                    scrolling = false;
                    //console.log(data.buttonIndex)
                    // if (data.buttonIndex == 0) {
                    // }
                    currentDecalIndex = index;
                    creating = true;
                    tattooAngle = 0;
                    tattooScale = originalScale;
                    // if(data.buttonIndex == 2)
                    // {
                    //     gd.removeControl(button1);
                    // }

                });

                // advancedTexture.addControl(button1); 
                button1.onPointerMoveObservable.add((data) => {
                    if (!scrolling)
                        return;
                    //console.log("move");
                    // console.log(data)
                    distanceMoved = data.y - scrollPos;
                    scrollPos = data.y;
                    //console.log(distanceMoved)
                    sv.verticalBar.value -= distanceMoved / compareWidth * 0.3;
                });
                button1.onPointerDownObservable.add((data) => {
                    scrollPos = data.y
                    scrolling = true;
                });
                // console.log(index + "calc height: " + calcHeight) 
                // console.log(index+"current top: " + currentTop)
                // console.log("added: " + name) 
                gd.height = currentTop + "px";
                gd.addRowDefinition(calcHeight, true)
                gd.addControl(button1, gd.children.length, 0)
                // console.log(gd.children.length)
            }
            var createTattooButtonFromFile = function (name, texture, index, size) {
                var ratio = size.width / size.height;
                //console.log("create image button")
                var button1 = BABYLON.GUI.Button.CreateImageOnlyButton(name + "Button", "Custom.png");
                // button1.image = texture;
                // console.log(button1.image)
                // console.log(texture)
                var buttonSize = compareWidth * scrollWidth - 15;
                var calcHeight = buttonSize;
                currentTop += calcHeight;

                // button1.left = (-buttonSize - 10) * currentCol;
                button1.width = buttonSize + "px"
                button1.height = buttonSize + "px";
                button1.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
                button1.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
                button1.color = "black";
                button1.background = "white";
                button1.cornerRadius = 10;

                button1.onPointerUpObservable.add(function (data) {
                    scrolling = false;
                    currentDecalIndex = index;
                    creating = true;
                    tattooAngle = 0;
                    tattooScale = originalScale;
                });

                // advancedTexture.addControl(button1); 
                button1.onPointerMoveObservable.add((data) => {
                    if (!scrolling)
                        return;
                    distanceMoved = data.y - scrollPos;
                    scrollPos = data.y;
                    sv.verticalBar.value -= distanceMoved / compareWidth * 0.3;
                });
                button1.onPointerDownObservable.add((data) => {
                    scrollPos = data.y
                    scrolling = true;
                });
                gd.height = currentTop + "px";
                gd.addRowDefinition(calcHeight, true)
                gd.addControl(button1, gd.children.length, 0)
                // console.log(gd.children.length)
            }
            var createTattooMaterial = function (name, url) {
                var decalMaterial0 = new BABYLON.StandardMaterial("decalMat", scene);
                decalMaterial0.diffuseColor = new BABYLON.Color3(1, 1, 1);
                decalMaterial0.ambientColor = new BABYLON.Color3(1, 1, 1);
                decalMaterial0.specularColor = new BABYLON.Color3(0.1, 0.1, 0.1);
                decalMaterials.push(decalMaterial0);
                decalMaterial0.zOffset = -2;
                decalMaterial0.diffuseTexture = new BABYLON.Texture(name + ".png", scene);
                decalMaterial0.diffuseTexture.hasAlpha = true;
                var index = decalMaterials.length - 1;
                decalMaterial0.diffuseTexture.onLoadObservable.add(() => {
                    var size = decalMaterial0.diffuseTexture.getSize();
                    createTattooButton(name, index, size);
                })
            }
            var createTattooMaterialFromFile = function (name, material) {
                var decalMaterial0 = new BABYLON.StandardMaterial("decalMat", scene);
                decalMaterial0.diffuseColor = new BABYLON.Color3(1, 1, 1);
                decalMaterial0.ambientColor = new BABYLON.Color3(1, 1, 1);
                decalMaterial0.specularColor = new BABYLON.Color3(0.1, 0.1, 0.1);
                decalMaterials.push(decalMaterial0);
                decalMaterial0.zOffset = -2;
                decalMaterial0.diffuseTexture = material;
                decalMaterial0.diffuseTexture.hasAlpha = true;
                var index = decalMaterials.length - 1;
                var size = decalMaterial0.diffuseTexture.getSize();
                createTattooButtonFromFile(name, material, index, size);
                // decalMaterial0.diffuseTexture.onLoadObservable.add(() => {
                // })
            }
            var createScrollView = function () {
                sv = new BABYLON.GUI.ScrollViewer();
                sv.width = scrollWidth;
                sv.height = 0.9;
                sv.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT
                sv.background = "";
                sv.forVerticalBar = false
                sv.barSize = 4
                sv.wheelPrecision = 0.02;
                advancedTexture.addControl(sv);

                gd = new BABYLON.GUI.Grid();
                gd.width = 1;

                sv.addControl(gd);
            }
            var createTattoo = function (name, url) {
                //console.log("Adding tattoo: " + url);
                // if (url == "")
                //     return;
                // if (!url.includes("https://i.imgur.com/")) {
                //     alert("Failed to create tattoo")
                //     return;
                // }            
                createTattooMaterial(name);

            }
            var createTattooFromFile = function (name, material) {
                createTattooMaterialFromFile(name, material);
            }
            // END GUI
            // MATERIALS
            var armMaterial = new BABYLON.StandardMaterial("armMaterial", scene);
            col = new BABYLON.Color3(198 / 255, 134 / 255, 66 / 255);
            armMaterial.diffuseColor = col;
            armMaterial.ambientColor = col;
            armMaterial.specularColor = new BABYLON.Color3(0.1, 0.1, 0.1);
            armMaterial.diffuseTexture = new BABYLON.Texture("https://media.istockphoto.com/id/176503085/photo/close-up-of-textured-light-colored-skin-with-beauty-spot.jpg?b=1&s=170667a&w=0&k=20&c=jLzfoTlwTf8Wo0woxwm7R_9nfsXebQ09cB-hLx782uc=", scene);
            // END MATERIALS
            loadModels(scene, armMaterial);

            var decalMaterials = [];
            // TEXT
            var createText = function () {
                var text1 = new BABYLON.GUI.TextBlock();
                if (isMobile)
                    text1.text = "Controls:\nCamera----\nRotate: Drag\nPan: 2 Finger drag\nZoom: Pinch\nTattoo----\nScale: +/- buttons\nRotate: </> buttons\nRemove: Double tap\nalso i didn't add a save feature oops";
                else
                    text1.text = "Controls:\nCamera----\nRotate: Middle Mouse + Drag\nPan: Right Mouse + Drag\nZoom: Mouse wheel\nTattoo----\nScale: Ctrl + Up/Down\nRotate: Shift + Up/Down\nRemove: Double click\nalso i didn't add a save feature oops";
                text1.color = "white";
                text1.textHorizontalAlignment = BABYLON.GUI.TextBlock.HORIZONTAL_ALIGNMENT_LEFT;
                text1.textVerticalAlignment = BABYLON.GUI.TextBlock.VERTICAL_ALIGNMENT_TOP;
                text1.fontSize = 16 + 'em';
                text1.top = 5;
                text1.left = 5;
                advancedTexture.addControl(text1);

                var text1 = new BABYLON.GUI.TextBlock();
                text1.text = "@chindianskateclub"
                text1.color = "white";
                text1.textHorizontalAlignment = BABYLON.GUI.TextBlock.HORIZONTAL_ALIGNMENT_RIGHT;
                text1.textVerticalAlignment = BABYLON.GUI.TextBlock.VERTICAL_ALIGNMENT_TOP;
                text1.fontSize = 16;
                text1.top = 5;
                text1.left = -5;
                advancedTexture.addControl(text1);


                // var text2 = new BABYLON.GUI.TextBlock();
                // text2.text = "This was designed for PC not mobile";
                // text2.color = "white";
                // text2.textHorizontalAlignment = BABYLON.GUI.TextBlock.HORIZONTAL_ALIGNMENT_CENTER;
                // text2.textVerticalAlignment = BABYLON.GUI.TextBlock.VERTICAL_ALIGNMENT_TOP;
                // text2.fontSize = 24;
                // text2.top = 5;
                // advancedTexture.addControl(text2);

                var createInput = function () {
                    var input = new BABYLON.GUI.InputText("", "");
                    input.color = "white";
                    input.horizontalAlignment = BABYLON.GUI.TextBlock.HORIZONTAL_ALIGNMENT_LEFT;
                    input.verticalAlignment = BABYLON.GUI.TextBlock.VERTICAL_ALIGNMENT_BOTTOM;
                    input.fontSize = 24;
                    input.height = "35px";
                    input.width = 0.3;
                    input.left = "5px";
                    input.top = -10;
                    input.onFocusObservable.add(() => {
                        inputFocus = true;
                        //console.log(inputFocus)
                    })
                    input.onBlurObservable.add(() => {
                        inputFocus = false;
                        //console.log(inputFocus)
                    })
                    advancedTexture.addControl(input);
                }

                var createAddCustomTattooButton = function () {
                    var addButton = BABYLON.GUI.Button.CreateSimpleButton("but1", "Add custom tattoo");
                    addButton.color = "white";
                    addButton.horizontalAlignment = BABYLON.GUI.TextBlock.HORIZONTAL_ALIGNMENT_RIGHT;
                    addButton.verticalAlignment = BABYLON.GUI.TextBlock.VERTICAL_ALIGNMENT_BOTTOM;
                    addButton.fontSize = 24;
                    addButton.width = '250px';
                    addButton.height = "35px";
                    addButton.left = -5;
                    addButton.top = -10;
                    addButton.onPointerUpObservable.add(function () {
                        var url = input.text;
                        createTattoo("custom", url);
                        input.text = "";
                    });
                    advancedTexture.addControl(addButton);
                }
                var tutorial = new BABYLON.GUI.TextBlock();
                //  tutorial.text = "How to add custom tattoo:\nFind image\nRemove BG with on https://www.remove.bg/\nUpload to imgur\nRight click > copy image address\nURL should be https://i.imgur.com/abcdefg.png";
                tutorial.text = "How to add custom tattoo:\nFind image\nRemove BG with on https://www.remove.bg/\nChoose file...";
                tutorial.color = "white";
                tutorial.textHorizontalAlignment = BABYLON.GUI.TextBlock.HORIZONTAL_ALIGNMENT_LEFT;
                tutorial.textVerticalAlignment = BABYLON.GUI.TextBlock.VERTICAL_ALIGNMENT_BOTTOM;
                tutorial.fontSize = 16;

                tutorial.top = -50;

                tutorial.left = "20x";
                advancedTexture.addControl(tutorial);

            }
            createText();


            createSkinColorButton(new BABYLON.Color3(141 / 255, 85 / 255, 36 / 255));
            createSkinColorButton(new BABYLON.Color3(198 / 255, 134 / 255, 66 / 255));
            createSkinColorButton(new BABYLON.Color3(241 / 255, 194 / 255, 125 / 255));
            createBodyButtons();
            // transform buttons
            var width = 80;
            var transOffset = 170;
            var button1 = BABYLON.GUI.Button.CreateSimpleButton("but1", "+");
            button1.width = width + "px"
            button1.height = width + "px";
            button1.top = -transOffset - 3 * width + "px";
            button1.color = new BABYLON.Color3(0, 0, 0).toHexString();
            button1.background = new BABYLON.Color3(0.9, 0.9, 0.9).toHexString();
            button1.left = 5;
            button1.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
            button1.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
            button1.cornerRadius = 100;
            button1.fontSize = 57;
            //button1.thickness = 4;
            numSkin++;
            button1.onPointerUpObservable.add(function () {
                if (!currentDecal)
                    return;
                tattooScale += 0.1;
                currentDecal.dispose();
                currentDecal = createDecal(currentDecalPickInfo, "placed");
            });
            advancedTexture.addControl(button1);
            var button1 = BABYLON.GUI.Button.CreateSimpleButton("but1", "-");
            button1.width = width + "px"
            button1.height = width + "px";
            button1.top = -transOffset - 2 * width + "px";
            button1.color = new BABYLON.Color3(0, 0, 0).toHexString();
            button1.background = new BABYLON.Color3(0.9, 0.9, 0.9).toHexString();
            button1.left = 5;
            button1.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
            button1.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
            button1.cornerRadius = 100;
            button1.fontSize = 57;
            //button1.thickness = 4;
            numSkin++;
            button1.onPointerUpObservable.add(function () {
                if (!currentDecal)
                    return;
                tattooScale -= 0.1;
                tattooScale = Math.max(minScale, tattooScale);
                currentDecal.dispose();
                currentDecal = createDecal(currentDecalPickInfo, "placed");
            });
            advancedTexture.addControl(button1);

            var button1 = BABYLON.GUI.Button.CreateSimpleButton("but1", ">");
            button1.width = width + "px"
            button1.height = width + "px";
            button1.top = -transOffset - 1 * width + 5 + "px";
            button1.color = new BABYLON.Color3(0, 0, 0).toHexString();
            button1.background = new BABYLON.Color3(0.9, 0.9, 0.9).toHexString();
            button1.left = 5;
            button1.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
            button1.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
            button1.cornerRadius = 100;
            button1.fontSize = 57;
            //button1.thickness = 4;
            numSkin++;
            button1.onPointerUpObservable.add(function () {
                if (!currentDecal)
                    return;
                tattooAngle -= 0.1;
                currentDecal.dispose();
                currentDecal = createDecal(currentDecalPickInfo, "placed");
            });
            advancedTexture.addControl(button1);
            var button1 = BABYLON.GUI.Button.CreateSimpleButton("but1", "<");
            button1.width = width + "px"
            button1.height = width + "px";
            button1.top = -transOffset - 0 * width + 5 + "px";
            button1.color = new BABYLON.Color3(0, 0, 0).toHexString();
            button1.background = new BABYLON.Color3(0.9, 0.9, 0.9).toHexString();
            button1.left = 5;
            button1.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
            button1.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
            button1.cornerRadius = 100;
            button1.fontSize = 57;
            //button1.thickness = 4;
            numSkin++;
            button1.onPointerUpObservable.add(function () {
                if (!currentDecal)
                    return;
                tattooAngle += 0.1;
                currentDecal.dispose();
                currentDecal = createDecal(currentDecalPickInfo, "placed");
            });
            advancedTexture.addControl(button1);
            createScrollView()
            // tattoo list
            createTattoo("Ghost_01")
            createTattoo("Ghost_02")
            createTattoo("Ghost_03")
            createTattoo("Skate")
            createTattoo("BirdSkull")
            createTattoo("Bottle")
            createTattoo("Butterfly")
            createTattoo("Califer")
            createTattoo("Candle")
            createTattoo("Eye")
            createTattoo("Feather")
            createTattoo("Frog")
            createTattoo("Hand")
            createTattoo("Jaguar")
            createTattoo("JAW")
            createTattoo("Mushroom")
            createTattoo("Rect")
            createTattoo("SkullRose")
            createTattoo("Sparkle")
            createTattoo("Spells")
            createTattoo("SplitSkull")
            createTattoo("UFO")
            createTattoo("WX1")
            createTattoo("wx2")
            //createTattoo("")
            // createTattoo("Bottle", "https://i.imgur.com/qembEh7.png")
            // createTattoo("Calcifer", "https://i.imgur.com/O8qyhyZ.png")
            // createTattoo("FLowerSkull", "https://i.imgur.com/sAWJt05.png")
            // createTattoo("Eye", "https://i.imgur.com/CxRmXjR.png")
            // createTattoo("SplitSkull", "https://i.imgur.com/lTIZom6.png")
            // createTattoo("Rect", "https://i.imgur.com/fOXWSXL.png")
            // createTattoo("Wolf", "https://i.imgur.com/W6MPtFK.png")
            // createTattoo("UFO", "https://i.imgur.com/ap91QG0.png")
            // createTattoo("JAW", "https://i.imgur.com/05c0fsS.png")
            // createTattoo("Bird", "https://i.imgur.com/mxkHFyx.png")
            // createTattoo("Butterfly", "https://i.imgur.com/xJsARn0.png")
            // createTattoo("Spells", "https://i.imgur.com/wx8Pn5r.png")
            // createTattoo("Candle", "https://i.imgur.com/Vb0ZF7o.png")
            // createTattoo("Frog", "https://i.imgur.com/etpzyJk.png")
            // createTattoo("Shroom", "https://i.imgur.com/uRoL04J.png")
            // createTattoo("Feather", "https://i.imgur.com/KLG4ktg.png")
            // createTattoo("Sparkle", "https://i.imgur.com/sIBZJlT.png")
            // createTattoo("Hand", "https://i.imgur.com/xn33EFK.png")
            // createTattoo("Hand", "https://i.imgur.com/606VJX0.png")
            // createTattoo("Hand", "https://i.imgur.com/7ez2JzE.png")
            // createTattoo("Misc", "")



            var createDecal = function (pickInfo, type) {
                currentDecalPickInfo = pickInfo;
                var material = decalMaterials[currentDecalIndex];
                ratio = material.diffuseTexture.getSize().width / material.diffuseTexture.getSize().height;
                var decalSize = new BABYLON.Vector3(ratio * tattooScale, tattooScale, tattooScale);
                var normal = pickInfo.getNormal(true);

                var decal = BABYLON.MeshBuilder.CreateDecal("decal", currentTargetBody, {
                    position: pickInfo.pickedPoint,
                    normal: normal,
                    size: decalSize,
                    angle: tattooAngle,
                    cullBackFaces: true,
                    localMode: true
                });
                decal.material = material;
                // decal.name = name + ':' + tattooScale + ";" + tattooAngle + ']' + currentDecalIndex;
                decal.data = { type: type, scale: tattooScale, angle: tattooAngle, decalIndex: currentDecalIndex };
                // console.log( decal.data);
                return decal;

            }
            var creating = false;
            var currentDecal = null;
            var selectDecal = function (pickInfo) {
                // pickInfo.pickedMesh.dispose();
                selected = true
                currentDecal = pickInfo.pickedMesh;
                var scale = currentDecal.data.scale;
                var angle = currentDecal.data.angle;
                var decalIndex = currentDecal.data.decalIndex;
                //console.log(rotation);
                // console.log(decalIndex);
                tattooScale = parseFloat(scale);
                tattooAngle = parseFloat(angle);
                // console.log('decalindex:' + decalIndex);
                currentDecalIndex = parseInt(decalIndex);
                camera.detachControl(canvas);
            }



            var downPosX = 0;
            var downPosY = 0;
            var prevPosX = 0;
            var prevPosY = 0;
            scene.onPointerObservable.add((pointerInfo) => {
                switch (pointerInfo.type) {
                    case BABYLON.PointerEventTypes.POINTERDOWN:
                        downPosX = scene.pointerX;
                        downPosY = scene.pointerY;
                        if (pointerInfo.event.button == 0 && !creating) // left click
                        {
                            var result = scene.multiPick(scene.unTranslatedPointer.x, scene.unTranslatedPointer.y);
                            var pickInfo;
                            for (i = 0; i < result.length; i++) {
                                // console.log(result[i]);
                                if (bodyMeshes.includes(result[i].pickedMesh))
                                    continue;
                                if (result[i].pickedMesh.data.type == "placed") {
                                    pickInfo = result[i];
                                    break;
                                }
                            }
                            if (pickInfo && pickInfo.hit)
                                selectDecal(pickInfo);
                        }
                        break;
                    case BABYLON.PointerEventTypes.POINTERUP:
                        if (selected) {
                            camera.attachControl(canvas, true);
                            // console.log("attached")
                            selected = false;
                            if (moved) {
                                currentDecal.dispose();
                                currentDecal = createDecal(currentDecalPickInfo, "placed")
                            }
                            moved = false;
                        }
                        else {
                            distanceMoved = Math.abs(scene.pointerX - downPosX) + Math.abs(scene.pointerY - downPosY);
                            // console.log(distanceMoved);

                            if (creating && distanceMoved < 5) {
                                creating = false;
                                var armPick = scene.pick(scene.pointerX, scene.pointerY, function (mesh) { return mesh === currentTargetBody; });
                                // var result = scene.multiPick(scene.unTranslatedPointer.x, scene.unTranslatedPointer.y);
                                // console.log(result);

                                if (armPick.hit) {
                                    currentDecal.dispose();
                                    currentDecal = createDecal(armPick, "placed");
                                    // console.log('placed');
                                }

                            }
                            // if (pointerInfo.event.button == 2 && distanceMoved < 5) // right click
                            // {
                            //     var result = scene.multiPick(scene.unTranslatedPointer.x, scene.unTranslatedPointer.y);
                            //     var pickInfo;
                            //     for (i = 0; i < result.length; i++) {
                            //         if (result[i].pickedMesh.name.includes('placed')) {
                            //             pickInfo = result[i];
                            //             break;
                            //         }
                            //     }
                            //     if (pickInfo) {
                            //         pickInfo.pickedMesh.dispose();
                            //     }
                            // }
                        }
                        break;
                    case BABYLON.PointerEventTypes.POINTERDOUBLETAP:
                        var result = scene.multiPick(scene.unTranslatedPointer.x, scene.unTranslatedPointer.y);
                        var pickInfo;
                        for (i = 0; i < result.length; i++) {
                            if (bodyMeshes.includes(result[i].pickedMesh))
                                continue;
                            if (result[i].pickedMesh.data.type == 'placed') {
                                pickInfo = result[i];
                                break;
                            }
                        }
                        if (pickInfo) {
                            pickInfo.pickedMesh.dispose();
                        }
                        break;
                    case BABYLON.PointerEventTypes.POINTERMOVE:
                        if (selected) {
                            //console.log(currentDecal);
                            moved = true;
                            currentDecal.dispose();
                            //distanceMoved = Math.abs(scene.pointerX - prevPosX) + Math.abs(scene.pointerY - prevPosY);
                            distanceMovedY = -(scene.pointerY - prevPosY);
                            distanceMovedX = (scene.pointerX - prevPosX);

                            if (scaling) {
                                tattooScale += (distanceMovedY) * 0.1;
                                tattooScale = Math.max(minScale, tattooScale);
                            }
                            if (rotating) {
                                tattooAngle += (distanceMovedX + distanceMovedY) * 0.01;
                            }
                            var armPick = scene.pick(scene.pointerX, scene.pointerY, function (mesh) { return mesh === currentTargetBody; });
                            if (armPick.hit) {
                                if (currentDecal && currentDecal.data.type == 'moving')
                                    currentDecal.dispose();
                                currentDecal = createDecal(armPick, 'moving');
                            }
                        }
                        if (creating) {
                            distanceMovedY = -(scene.pointerY - prevPosY);
                            distanceMovedX = -(scene.pointerX - prevPosX);
                            if (scaling) {
                                tattooScale += (distanceMovedX + distanceMovedY) * 0.1;
                                tattooScale = Math.max(minScale, tattooScale);
                            }
                            if (rotating) {
                                tattooAngle += (distanceMovedX + distanceMovedY) * 0.01;
                            }
                            var armPick = scene.pick(scene.pointerX, scene.pointerY, function (mesh) { return mesh === currentTargetBody; });

                            if (currentDecal && currentDecal.data.type == 'creating')
                                currentDecal.dispose();
                            if (armPick.hit) {
                                currentDecal = createDecal(armPick, 'creating');
                            }
                        }
                        prevPosX = scene.pointerX;
                        prevPosY = scene.pointerY;

                        break;
                    case BABYLON.PointerEventTypes.POINTERWHEEL:

                        break;

                }
            });

            scene.onKeyboardObservable.add((kbInfo) => {
                switch (kbInfo.type) {
                    case BABYLON.KeyboardEventTypes.KEYDOWN:
                        switch (kbInfo.event.key) {
                            case "Control":
                                scaling = true;
                                break
                            case "Shift":
                                rotating = true;
                                break
                        }
                        break;
                    case BABYLON.KeyboardEventTypes.KEYUP:
                        switch (kbInfo.event.key) {
                            case "Control":
                                scaling = false;
                                break
                            case "Shift":
                                rotating = false;
                                break
                        }
                        break;
                }
            });

            // Activate the clipboard events listener
            advancedTexture.registerClipboardEvents();
            // Add event listener to onClipboardObservable
            advancedTexture.onClipboardObservable.add((ev) => {
                // Copy listener
                if (ev.type === BABYLON.ClipboardEventTypes.COPY) {
                    // console.log("copy")

                }
                // Paste listener
                if (ev.type === BABYLON.ClipboardEventTypes.PASTE) {
                    if (inputFocus)
                        return;
                    //console.log("paste")
                    //zconsole.log(ev.event.clipboardData)
                    var textData = ev.event.clipboardData.getData("text/plain");
                    // console.log(textData)
                    if (textData.includes("https://i.imgur.com/"))
                        createTattoo("", textData);
                }
            });
            // Load

            let assetsManager = new BABYLON.AssetsManager(scene);
            //called when a single task has been sucessfull
            assetsManager.onTaskSuccessObservable.add(function (task) {
                // var mesh = task.loadedMeshes[0]; //will hold the mesh that has been loaded recently
                // console.log('task successful', task);
            });

            assetsManager.onTaskErrorObservable.add(function (task) {
                console.log('task failed', task.errorObject.message, task.errorObject.exception);
                alert('unable to load image')
            });

            var loadButton = document.getElementById('loadFile');
            loadButton.onchange = function (evt) {

                var files = evt.target.files;
                var filename = files[0].name;
                var blob = new Blob([files[0]]);
                console.log(files)
                BABYLON.FilesInput.FilesToLoad[filename.toLowerCase()] = blob;

                //assetsManager.addMeshTask(name, "", "file:", filename);
                var imageTask = assetsManager.addTextureTask(name, "file:" + filename);
                imageTask.onSuccess = function (task) {
                    // bodyMeshes[0].material.diffuseTexture = task.texture;
                    console.log(task)
                    createTattooFromFile(name, task.texture)
                }
                assetsManager.load();
            };
            //

            return scene;
        }
        window.initFunction = async function () {


            var asyncEngineCreation = async function () {
                try {
                    return createDefaultEngine();
                } catch (e) {
                    console.log("the available createEngine function failed. Creating the default engine instead");
                    return createDefaultEngine();
                }
            }

            window.engine = await asyncEngineCreation();
            if (!engine) throw 'engine should not be null.';
            startRenderLoop(engine, canvas);
            window.scene = createScene();
        };
        initFunction().then(() => {
            sceneToRender = scene
        });

        // Resize
        window.addEventListener("resize", function () {
            engine.resize();
        });
    </script>
</body>

</html>